<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>mmdetection 自定义数据增强 | Infinite's Blog</title><meta name="author" content="infinite-zh"><meta name="copyright" content="infinite-zh"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="mmdetection-custom-data-augmentation前言目前的数据集内基本是检测小目标，但是因为小物体检测比较困难，需要想办法提升小目标的检测结果。最近读了一篇《Augmentation for small object detection》的论文，里面讲了一些数据增强的方法来提高小目标的检测效果。 mmdetection是一个基于pytorch的目标检测工具箱，简单易用。本篇">
<meta property="og:type" content="article">
<meta property="og:title" content="mmdetection 自定义数据增强">
<meta property="og:url" content="http://example.com/2022/05/09/mmdetection-custom-data-augmentation/index.html">
<meta property="og:site_name" content="Infinite&#39;s Blog">
<meta property="og:description" content="mmdetection-custom-data-augmentation前言目前的数据集内基本是检测小目标，但是因为小物体检测比较困难，需要想办法提升小目标的检测结果。最近读了一篇《Augmentation for small object detection》的论文，里面讲了一些数据增强的方法来提高小目标的检测效果。 mmdetection是一个基于pytorch的目标检测工具箱，简单易用。本篇">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2022-05-09T05:00:00.000Z">
<meta property="article:modified_time" content="2024-05-15T08:55:50.536Z">
<meta property="article:author" content="infinite-zh">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/05/09/mmdetection-custom-data-augmentation/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'mmdetection 自定义数据增强',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-15 16:55:50'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://sdifmsux4.hd-bkt.clouddn.com/theme/102707540_p0.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Infinite's Blog"><span class="site-name">Infinite's Blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mmdetection 自定义数据增强</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-09T05:00:00.000Z" title="发表于 2022-05-09 13:00:00">2022-05-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-15T08:55:50.536Z" title="更新于 2024-05-15 16:55:50">2024-05-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="mmdetection 自定义数据增强"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="mmdetection-custom-data-augmentation"><a href="#mmdetection-custom-data-augmentation" class="headerlink" title="mmdetection-custom-data-augmentation"></a>mmdetection-custom-data-augmentation</h2><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>目前的数据集内基本是检测小目标，但是因为小物体检测比较困难，需要想办法提升小目标的检测结果。最近读了一篇《Augmentation for small object detection》的论文，里面讲了一些数据增强的方法来提高小目标的检测效果。</p>
<p>mmdetection是一个基于pytorch的目标检测工具箱，简单易用。本篇博客的主要目的基于mmdetection实现一个数据增强方法。</p>
<h1 id="SmallObjectAugmentation"><a href="#SmallObjectAugmentation" class="headerlink" title="SmallObjectAugmentation"></a>SmallObjectAugmentation</h1><p><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1902.07296">Augmentation for small object detection</a>的论文里面讲述几种小目标增强方法</p>
<h2 id="过采样"><a href="#过采样" class="headerlink" title="过采样"></a>过采样</h2><blockquote>
<p>In the first set of experiments, we investigate the effect of oversampling images containing small objects. We vary the oversampling ratio between two, three and four. Instead of actual stochastic oversampling, we create multiple copies of images with small objects offline for efficiency</p>
</blockquote>
<p>这是一个花费精力比较少且简单的方法，简单来说就是如果图片中有小目标，就在训练集中将这个图片多复制几次。</p>
<h2 id="增强"><a href="#增强" class="headerlink" title="增强"></a>增强</h2><blockquote>
<p>In the second set of experiments, we investigate the effects of using augmentation on small object detection and segmentation. We copy and paste all small objects in each image once. We also oversample images with small objects to study the interaction between the oversampling and augmentation strategies.</p>
</blockquote>
<p>另一种方法就是在每张图片中，将图片的包含小目标复制粘贴多次。在文中一共提出了三种复制粘贴策略</p>
<ol>
<li>选择一张图中的一个小目标，在随机位置中复制粘贴多次</li>
<li>选择许多小物体，复制粘贴在随机地方</li>
<li>选择每张图片的全部小物体，复制粘贴一次在随机地方</li>
</ol>
<p>后文还提到复制粘贴时需要注意复制粘贴的时候不能和之前的标签重叠</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>arXiv上的论文并没有给出官方实现，只有社区实现。因此这里直接参考社区的实现方法。</p>
<p>mmdetection的<a target="_blank" rel="noopener" href="https://mmdetection.readthedocs.io/en/v2.21.0/">文档</a>中给出了自定义pipelines数据增强的方法，我们只需要实现自己的<code>__init__</code>函数和<code>__call__</code>函数，然后通过<code>@PIPELINES.register_module()</code>注册即可。<code>__call__</code>函数的输入参数和输出参数都是<code>results</code>，这是一个包含了图像、边界框和标签等信息的字典。</p>
<p>官方提供的pipelines如下图所示</p>
<p><img src="http://sdifmsux4.hd-bkt.clouddn.com/mmdetection-custom-data-augmentation/data_pipeline.png" alt="image-20220823215053701"></p>
<p>通过阅读源码和观看这张图我们可以得知模型中最后使用的是<code>results[&#39;img&#39;]</code>、<code>results[&#39;gt_bboxes&#39;]</code>、<code>results[&#39;gt_labels&#39;]</code>等，其中<code>gt_bboxes</code>的格式是<code>(list[Tensor])</code>其中每个bbox的格式是<code>[tl_x, tl_y, br_x, br_y]</code>即左上角的点坐标和右下角的点坐标。</p>
<p>知道格式后实现起来就比较简单，源码就放在文末。</p>
<p>在<code>mmdet/datasets/pipelines</code>文件夹内新建<code>SmallObjectAugmentation.py</code>,并写入文末的源码。</p>
<p>导入模块时<code>mmdetection</code>有两种方法</p>
<h2 id="方法一-重新编译"><a href="#方法一-重新编译" class="headerlink" title="方法一 重新编译"></a>方法一 重新编译</h2><p><a target="_blank" rel="noopener" href="https://mmdetection.readthedocs.io/en/v2.21.0/get_started.html#install-mmdetection">参考</a></p>
<p><code>mmdet/datasets/pipelines</code>里的<code>__init__.py</code>文件中添加<code>from .SmallObjectAugmentation import SmallObjectAugmentation</code>,<code>__all__</code>添加<code>&#39;SmallObjectAugmentation&#39;</code>，完整修改见下<br><img src="http://sdifmsux4.hd-bkt.clouddn.com/mmdetection-custom-data-augmentation/custom_init.png" alt="img"></p>
<p>然后执行下面的命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements/build.txt</span><br><span class="line">pip install -v -e .  <span class="comment"># or &quot;python setup.py develop&quot;</span></span><br></pre></td></tr></table></figure>

<p>这样就完成了，实际上执行速度很快。这样就可以直接在你的config文件中使用</p>
<h2 id="方法二-修改config"><a href="#方法二-修改config" class="headerlink" title="方法二 修改config"></a>方法二 修改config</h2><p><a target="_blank" rel="noopener" href="https://mmdetection.readthedocs.io/en/v2.21.0/tutorials/data_pipeline.html#extend-and-use-custom-pipelines">参考</a></p>
<p>这种方法我没有成功，读者可以自己尝试一下</p>
<p>修改config文件，在里面加一条，保证路径是训练脚本的相似路径</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">custom_imports = <span class="built_in">dict</span>(imports=[<span class="string">&#x27;path.to.my_pipeline&#x27;</span>], allow_failed_imports=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h1 id="查看数据增强效果"><a href="#查看数据增强效果" class="headerlink" title="查看数据增强效果"></a>查看数据增强效果</h1><p>mmdetection有提供工具让我们看数据增强的效果。<br>首先先准备一份config文件，我这里直接继承<code>yolox_tiny_8x8_300e_coco.py</code>修改其中的<code>train_pipeline</code>，去除其他的数据增强，只留下我们自己的增强方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train_pipeline = [</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;SmallObjectAugmentation&#x27;</span>,all_objects=<span class="literal">True</span>,thresh=<span class="number">400</span>*<span class="number">400</span>,prob=<span class="number">0.7</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;DefaultFormatBundle&#x27;</span>),</span><br><span class="line">    <span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">&#x27;Collect&#x27;</span>, keys=[<span class="string">&#x27;img&#x27;</span>, <span class="string">&#x27;gt_bboxes&#x27;</span>, <span class="string">&#x27;gt_labels&#x27;</span>])</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>然后我们可以使用mmdetection提供的工具来查看我们的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行下面这句话 需要把config的路径改成你的config路径</span></span><br><span class="line">python .\tools\misc\browse_dataset.py your_config_path</span><br></pre></td></tr></table></figure>

<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>为了展示效果，我这里把参数都调的夸张了点</p>
<p><img src="http://sdifmsux4.hd-bkt.clouddn.com/mmdetection-custom-data-augmentation/augmentation1.png" alt="sample1"></p>
<p><img src="http://sdifmsux4.hd-bkt.clouddn.com/mmdetection-custom-data-augmentation/augmentation3.png" alt="sample3"></p>
<h1 id="训练效果"><a href="#训练效果" class="headerlink" title="训练效果"></a>训练效果</h1><p>使用了数据增强前后的对比如下图所示，可以看到实际的训练效果有提高1%，可见效果还是可以的</p>
<p><img src="http://sdifmsux4.hd-bkt.clouddn.com/mmdetection-custom-data-augmentation/old.png" alt="增强前"></p>
<p><img src="http://sdifmsux4.hd-bkt.clouddn.com/mmdetection-custom-data-augmentation/new.png" alt="增强后"></p>
<h1 id="增强源码"><a href="#增强源码" class="headerlink" title="增强源码"></a>增强源码</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ..builder <span class="keyword">import</span> PIPELINES</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="meta">@PIPELINES.register_module(<span class="params"><span class="string">&#x27;SmallObjectAugmentation&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SmallObjectAugmentation</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, thresh=<span class="number">64</span>*<span class="number">64</span>, prob=<span class="number">0.5</span>, copy_times=<span class="number">3</span>, epochs=<span class="number">30</span>, all_objects=<span class="literal">False</span>, one_object=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        SmallObjectAugmentation: https://arxiv.org/abs/1902.07296</span></span><br><span class="line"><span class="string">        https://github.com/zzl-pointcloud/Data_Augmentation_Zoo_for_Object_Detection/blob/master/augmentation_zoo/SmallObjectAugmentation.py</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">            thresh: small object thresh</span></span><br><span class="line"><span class="string">            prob: the probability of whether to augmentation</span></span><br><span class="line"><span class="string">            copy_times: how many times to copy anno</span></span><br><span class="line"><span class="string">            epochs: how many times try to create anno</span></span><br><span class="line"><span class="string">            all_object: copy all object once</span></span><br><span class="line"><span class="string">            one_object: copy one object</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.thresh = thresh</span><br><span class="line">        self.prob = prob</span><br><span class="line">        self.copy_times = copy_times</span><br><span class="line">        self.epochs = epochs</span><br><span class="line">        self.all_objects = all_objects</span><br><span class="line">        self.one_object = one_object</span><br><span class="line">        <span class="keyword">if</span> self.all_objects <span class="keyword">or</span> self.one_object:</span><br><span class="line">            self.copy_times = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_is_small_object</span>(<span class="params">self, height, width</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        判断是否为小目标</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> height*width &lt;= self.thresh:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_compute_overlap</span>(<span class="params">self, bbox_a, bbox_b</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        计算重叠</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> bbox_a <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        left_max = <span class="built_in">max</span>(bbox_a[<span class="number">0</span>], bbox_b[<span class="number">0</span>])</span><br><span class="line">        top_max = <span class="built_in">max</span>(bbox_a[<span class="number">1</span>], bbox_b[<span class="number">1</span>])</span><br><span class="line">        right_min = <span class="built_in">min</span>(bbox_a[<span class="number">2</span>], bbox_b[<span class="number">2</span>])</span><br><span class="line">        bottom_min = <span class="built_in">min</span>(bbox_a[<span class="number">3</span>], bbox_b[<span class="number">3</span>])</span><br><span class="line">        inter = <span class="built_in">max</span>(<span class="number">0</span>, (right_min-left_max)) * <span class="built_in">max</span>(<span class="number">0</span>, (bottom_min-top_max))</span><br><span class="line">        <span class="keyword">if</span> inter != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_donot_overlap</span>(<span class="params">self, new_bbox, bboxes</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        是否有重叠</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> bbox <span class="keyword">in</span> bboxes:</span><br><span class="line">            <span class="keyword">if</span> self._compute_overlap(new_bbox, bbox):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_copy_annot</span>(<span class="params">self, height, width, bbox, bboxes</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        创建新的标签</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        bbox_h, bbox_w = bbox[<span class="number">3</span>] - bbox[<span class="number">1</span>], bbox[<span class="number">2</span>] - bbox[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(self.epochs):</span><br><span class="line">            random_x, random_y = np.random.randint(<span class="built_in">int</span>(bbox_w / <span class="number">2</span>), <span class="built_in">int</span>(width - bbox_w / <span class="number">2</span>)), \</span><br><span class="line">                np.random.randint(<span class="built_in">int</span>(bbox_h / <span class="number">2</span>), <span class="built_in">int</span>(height - bbox_h / <span class="number">2</span>))</span><br><span class="line">            tl_x, tl_y = random_x - bbox_w/<span class="number">2</span>, random_y-bbox_h/<span class="number">2</span></span><br><span class="line">            br_x, br_y = tl_x + bbox_w, tl_y + bbox_h</span><br><span class="line">            <span class="keyword">if</span> tl_x &lt; <span class="number">0</span> <span class="keyword">or</span> br_x &gt; width <span class="keyword">or</span> tl_y &lt; <span class="number">0</span> <span class="keyword">or</span> tl_y &gt; height:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            new_bbox = np.array([tl_x, tl_y, br_x, br_y], dtype=np.int32)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._donot_overlap(new_bbox, bboxes):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> new_bbox</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_add_patch_in_img</span>(<span class="params">self, new_bbox, copy_bbox, image</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        复制图像区域</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        copy_bbox = copy_bbox.astype(np.int32)</span><br><span class="line">        image[new_bbox[<span class="number">1</span>]:new_bbox[<span class="number">3</span>], new_bbox[<span class="number">0</span>]:new_bbox[<span class="number">2</span>],</span><br><span class="line">              :] = image[copy_bbox[<span class="number">1</span>]:copy_bbox[<span class="number">3</span>], copy_bbox[<span class="number">0</span>]:copy_bbox[<span class="number">2</span>], :]</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, results</span>):</span><br><span class="line">        <span class="keyword">if</span> self.all_objects <span class="keyword">and</span> self.one_object:</span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line">        <span class="keyword">if</span> np.random.rand() &gt; self.prob:</span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">        img = results[<span class="string">&#x27;img&#x27;</span>]</span><br><span class="line">        bboxes = results[<span class="string">&#x27;gt_bboxes&#x27;</span>]</span><br><span class="line">        labels = results[<span class="string">&#x27;gt_labels&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        height, width = img.shape[<span class="number">0</span>], img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        small_object_list = []</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(bboxes)):</span><br><span class="line">            bbox = bboxes[idx]</span><br><span class="line">            bbox_h, bbox_w = bbox[<span class="number">3</span>] - bbox[<span class="number">1</span>], bbox[<span class="number">2</span>] - bbox[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> self._is_small_object(bbox_h, bbox_w):</span><br><span class="line">                small_object_list.append(idx)</span><br><span class="line"></span><br><span class="line">        length = <span class="built_in">len</span>(small_object_list)</span><br><span class="line">        <span class="comment"># 无小物体</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> == length:</span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 随机选择不同的物体复制</span></span><br><span class="line">        copy_object_num = np.random.randint(<span class="number">0</span>, length)</span><br><span class="line">        <span class="keyword">if</span> self.all_objects:</span><br><span class="line">            <span class="comment"># 复制全部物体</span></span><br><span class="line">            copy_object_num = length</span><br><span class="line">        <span class="keyword">if</span> self.one_object:</span><br><span class="line">            <span class="comment"># 只选择一个物体复制</span></span><br><span class="line">            copy_object_num = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        random_list = random.sample(<span class="built_in">range</span>(length), copy_object_num)</span><br><span class="line">        idx_of_small_objects = [small_object_list[idx] <span class="keyword">for</span> idx <span class="keyword">in</span> random_list]</span><br><span class="line">        select_bboxes = bboxes[idx_of_small_objects, :]</span><br><span class="line">        select_labels = labels[idx_of_small_objects]</span><br><span class="line"></span><br><span class="line">        bboxes = bboxes.tolist()</span><br><span class="line">        labels = labels.tolist()</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(copy_object_num):</span><br><span class="line">            bbox = select_bboxes[idx]</span><br><span class="line">            label = select_labels[idx]</span><br><span class="line"></span><br><span class="line">            bbox_h, bbox_w = bbox[<span class="number">3</span>] - bbox[<span class="number">1</span>], bbox[<span class="number">2</span>] - bbox[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._is_small_object(bbox_h, bbox_w):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.copy_times):</span><br><span class="line">                new_bbox = self._create_copy_annot(height, width, bbox, bboxes)</span><br><span class="line">                <span class="keyword">if</span> new_bbox <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    img = self._add_patch_in_img(new_bbox, bbox, img)</span><br><span class="line">                    bboxes.append(new_bbox)</span><br><span class="line">                    labels.append(label)</span><br><span class="line"></span><br><span class="line">        results[<span class="string">&#x27;img&#x27;</span>] = img</span><br><span class="line">        results[<span class="string">&#x27;gt_bboxes&#x27;</span>] = np.array(bboxes)</span><br><span class="line">        results[<span class="string">&#x27;gt_labels&#x27;</span>] = np.array(labels)</span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>

<h1 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h1><p>转载自<a target="_blank" rel="noopener" href="http://qianxu.run/2022/05/05/mmdetection-custom-pipelines/">http://qianxu.run/2022/05/05/mmdetection-custom-pipelines/</a><br>感谢<a target="_blank" rel="noopener" href="http://qianxu.run/">钱佬</a>的实现。</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1902.07296">Augmentation for small object detection</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/zzl-pointcloud/Data_Augmentation_Zoo_for_Object_Detection">Data_Augmentation_Zoo_for_Object_Detection</a></p>
<p><a target="_blank" rel="noopener" href="https://mmdetection.readthedocs.io/en/v2.21.0/">mmdetection doc</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">infinite-zh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/05/09/mmdetection-custom-data-augmentation/">http://example.com/2022/05/09/mmdetection-custom-data-augmentation/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Infinite's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/22/iwr6843-mmwaveicboost/" title="IWR6843 + MMWAVEICBOOST 开箱使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">IWR6843 + MMWAVEICBOOST 开箱使用</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/09/kaggle-mmdet-tensorboard/" title="kaggle上mmdet的使用与tensorboard的解决方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">kaggle上mmdet的使用与tensorboard的解决方案</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">infinite-zh</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#mmdetection-custom-data-augmentation"><span class="toc-number">1.</span> <span class="toc-text">mmdetection-custom-data-augmentation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number"></span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SmallObjectAugmentation"><span class="toc-number"></span> <span class="toc-text">SmallObjectAugmentation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E9%87%87%E6%A0%B7"><span class="toc-number">1.</span> <span class="toc-text">过采样</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%BC%BA"><span class="toc-number">2.</span> <span class="toc-text">增强</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number"></span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91"><span class="toc-number">1.</span> <span class="toc-text">方法一 重新编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-%E4%BF%AE%E6%94%B9config"><span class="toc-number">2.</span> <span class="toc-text">方法二 修改config</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA%E6%95%88%E6%9E%9C"><span class="toc-number"></span> <span class="toc-text">查看数据增强效果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-number">1.</span> <span class="toc-text">效果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E6%95%88%E6%9E%9C"><span class="toc-number"></span> <span class="toc-text">训练效果</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E5%BC%BA%E6%BA%90%E7%A0%81"><span class="toc-number"></span> <span class="toc-text">增强源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%B4%E8%B0%A2"><span class="toc-number"></span> <span class="toc-text">致谢</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number"></span> <span class="toc-text">参考文献</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/06/06/server-development-environment-setup-guide/" title="服务器开发环境配置指南">服务器开发环境配置指南</a><time datetime="2023-06-06T05:00:00.000Z" title="发表于 2023-06-06 13:00:00">2023-06-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/03/21/aliyun-chatgpt-wechat/" title="阿里云部署ChatGPT并实现微信接入">阿里云部署ChatGPT并实现微信接入</a><time datetime="2023-03-21T00:00:00.000Z" title="发表于 2023-03-21 08:00:00">2023-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/12/24/quartz-learning/" title="分布式定时任务Quartz学习与使用">分布式定时任务Quartz学习与使用</a><time datetime="2022-12-24T05:00:00.000Z" title="发表于 2022-12-24 13:00:00">2022-12-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/12/21/JWT/" title="JWT学习与使用">JWT学习与使用</a><time datetime="2022-12-21T00:15:00.000Z" title="发表于 2022-12-21 08:15:00">2022-12-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/12/05/markdown2pdf/" title="Markdown转PDF">Markdown转PDF</a><time datetime="2022-12-05T05:52:00.000Z" title="发表于 2022-12-05 13:52:00">2022-12-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By infinite-zh</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>